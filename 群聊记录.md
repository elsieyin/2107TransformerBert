ä»¥ä¸‹å›ç­”åŸºæœ¬éƒ½æ¥è‡ªå¯å¯çˆ±çˆ±åŠ©æ•™è‡´Great

#### slotåˆ‡ç‰‡æ’åº

riaï¼š![image-20210730161953815](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730161953815.png)

è¿™ä¸ªåœ°æ–¹ç›¸å½“äºæ˜¯æŒ‰ç…§slotsåˆ‡ç‰‡æ’åºï¼Œè¿™ä¸ªå±äºPythonçš„sortå¤šçº§æ’åºï¼Œç»™ä½ çœ‹ä¸ªä¾‹å­![image-20210730162023518](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730162023518.png)
slot_voabé‡æ–°æ’ä¸‹åºï¼Œç„¶åé¦–é€‰æŒ‰ç…§slot_vocabæ¯ä¸ªå…ƒç´ çš„[2:]æ’åºï¼Œå¦‚æœ[2:]ç›¸åŒçš„è¯å°±æŒ‰ç…§å…ƒç´ çš„[:2]éƒ¨åˆ†æ’åº



éº¦å…‹é˜¿ç‘Ÿï¼š![image-20210730162057591](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730162057591.png)

loss = loss / self.args.gradient_accumulation_stepsï¼Œè¯·é—®è¿™å¥è¯æ˜¯ä¸æ˜¯åº”è¯¥å†™åœ¨é‚£åº•ä¸‹å•Šï¼Œåº”è¯¥åœ¨stepçš„æ—¶å€™å†å»å¹³å‡å§ï¼Ÿ
ä¸æ˜¯ï¼Œå°±æ˜¯åœ¨å¤–è¾¹æ±‚ï¼Œåœ¨stepé‚£ä¸€æ­¥æ˜¯ç´¯ç§¯æ¢¯åº¦æ±‚å¯¼çš„ï¼Œå¤–è¾¹è¿™ä¸ªæ˜¯å¯¹lossè¿›è¡Œæ ‡å‡†åŒ–ã€‚
æ¯ç´¯ç§¯ä¸€æ¬¡éƒ½è¦é™¤å˜›ï¼Ÿä¸åº”è¯¥ç´¯ç§¯gradient_accumulation_stepsæ¬¡æ‰é™¤ä»¥å®ƒå˜›ï¼Œä¸ºä»€ä¹ˆ1æ¯ç´¯ç§¯ä¸€æ¬¡å°±é™¤ä»¥.gradient_accumulation_stepså•Šï¼Ÿ
ä¸æ˜¯ï¼Œè¿™é‡Œç´¯ç§¯æŒ‡çš„æ˜¯æ¢¯åº¦ç´¯ç§¯ï¼Œlossçš„è¯ç›´æ¥å¹³å‡å°±å¯ä»¥ï¼Œå…¶å®è¿™é‡Œlossä¸åšå¹³å‡ä¹Ÿå¯ä»¥ï¼Œè¿™é‡Œå¯ä»¥ç¨å¾®æ”¹å†™ä¸‹ã€‚
é‚£åº”è¯¥æ€ä¹ˆæ”¹å•Šï¼Œæ¯ä¸€æ¬¡éƒ½é™¤çš„è¯ï¼Œä¹Ÿä¼šå½±å“æ¢¯åº¦å•Š
![image-20210730162314557](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730162314557.png)

æ”¹æˆè¿™æ ·çš„ï¼Œlossä¸ç”¨å¹³å‡ï¼Œå› ä¸ºlossæ²¡æœ‰ç´¯åŠ ï¼Œè¿˜æ˜¯ç›´æ¥ä»model(**inputs)ç®—å‡ºæ¥çš„.https://gist.github.com/thomwolf/ac7a7da6b1888c2eeac8ac8b9b05d3d3#file-gradient_accumulation-py

```python
model.zero_grad()                                   # Reset gradients tensors
for i, (inputs, labels) in enumerate(training_set):
    predictions = model(inputs)                     # Forward pass
    loss = loss_function(predictions, labels)       # Compute loss function
    loss = loss / accumulation_steps                # Normalize our loss (if averaged)
    loss.backward()                                 # Backward pass
    if (i+1) % accumulation_steps == 0:             # Wait for several backward steps
        optimizer.step()                            # Now we can do an optimizer step
        model.zero_grad()                           # Reset gradients tensors
        if (i+1) % evaluation_steps == 0:           # Evaluate the model when we...
            evaluate_model()                        # ...have no gradients accumulated
@muaz-git

```

æˆ‘å¤§æ¦‚ç†è§£å•¦ã€‚ã€‚ã€‚ä¹Ÿå°±æ˜¯åªè¦ä¸zeroæ“ä½œï¼Œæ¯ä¸€æ¬¡è®¡ç®—lossçš„æ—¶å€™ï¼Œä¹‹å‰è®¡ç®—çš„ä¹Ÿä¼šç´¯ç§¯åˆ°ã€‚ã€‚ä¹Ÿå°±æ˜¯è®¡ç®—ç¬¬næ¬¡lossçš„æ—¶å€™ï¼Œæ±‚backwardçš„æ—¶å€™ä¼šè®¡ç®—å‡º1åˆ°nçš„æ¢¯åº¦ï¼Œæ˜¯è¿™ä¸ªæ„æ€å˜›ï¼Ÿ
å¯¹çš„![image-20210730162449277](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730162449277.png)

![image-20210730162458524](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730162458524.png)

ä½ çœ‹è¿™ä¸ªpytorchçš„ä¾‹å­å°±æ˜ç™½äº†

æ°¸ä¸‰å°ºï¼š<img src="C:/Users/86182/AppData/Roaming/Typora/typora-user-images/image-20210730155041699.png" alt="image-20210730155041699" style="zoom: 67%;" />

![image-20210730155046494](C:/Users/86182/AppData/Roaming/Typora/typora-user-images/image-20210730155046494.png)

![image-20210730155054132](C:/Users/86182/AppData/Roaming/Typora/typora-user-images/image-20210730155054132.png)

è¯·é—®è¿™é‡Œæ„å»ºtoken_type_idsæ—¶ï¼Œå…¨éƒ¨éƒ½æ˜¯ç”¨0æ¥å»ºæ¨¡ï¼Œæœ€åçš„embeddingä¹Ÿéƒ½æ˜¯0ï¼Œé‚£è¿™ä¸ªtoken_type_idsæœ‰ä»€ä¹ˆæ„ä¹‰å•Šï¼Ÿ
æ˜¯å¦æ˜¯ç¬¬äºŒå¥è¯ï¼Œé’ˆå¯¹text pariä»»åŠ¡è€Œè¨€çš„ï¼Œè¿™é‡Œæ¯ä¸ªæ ·æœ¬è¾“å…¥åªæœ‰ä¸€ä¸ªtextï¼Œæ‰€ä»¥token type idséƒ½æ˜¯0ï¼Œä»£è¡¨æ‰€æœ‰tokenéƒ½æ˜¯æ¥è‡ªä¸€å¥è¯ã€‚
å¦‚æœæ ·æœ¬åªæœ‰ä¸€å¥è¯ï¼Œé‚£è¿™ä¸ªæ“ä½œä¹Ÿæ˜¯å¿…é¡»çš„å—ï¼Ÿ
ä¸ç®¡æ˜¯ä¸€å¥è¯è¿˜æ˜¯ä¸¤å¥è¯éƒ½æ˜¯éœ€è¦çš„ï¼Œæ¨¡å‹çš„è¾“å…¥åŒ…æ‹¬ä¸¤ä¸ªè¾“å…¥ï¼Œä¸€ä¸ªtokenids ä¸€ä¸ªæ˜¯token_typeidsã€‚
é‚£ position_embeddingä¸ºä»€ä¹ˆå¯ä»¥æ²¡æœ‰å•Šï¼Ÿ
è¿™ä¸ªä¸éœ€è¦ï¼Œè¿™ä¸ªæ˜¯æ¨¡å‹çš„æƒé‡å‚æ•°ï¼Œä¸æ˜¯è¾“å…¥ã€‚

éº¦å…‹é˜¿ç‘Ÿï¼šberté‡Œ1ä¸ªå•è¯è¿˜èƒ½æ‹†æˆå¤šä»½å˜›ï¼Ÿè¿™ä¸ªä¾ç…§ä»€ä¹ˆè§„å¾‹æ‹†å•Šï¼Ÿ
![image-20210730155509706](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730155509706.png)

WordPieceåˆ†è¯ï¼Œå¯ä»¥äº§ç”Ÿsubword
æŠŠä¸­æ–‡çš„nerç”¨bertä¼šå‡ºç°è¿™ç§æƒ…å†µå˜›ï¼Ÿ
ä¸ä¼šï¼Œä¸­æ–‡çš„å­—éƒ½æ˜¯å•ä¸ªç²’åº¦ï¼Œè‹±æ–‡çš„ä¸€ä¸ªå­—æ˜¯å¤šä¸ªå­—æ¯ã€‚
å’±ä»¬è¯¾ä¸Šè®²çš„å…³ç³»æŠ½å–ä»£ç ï¼Œåªèƒ½ä¸€å¥è¯æŠ½å–ä¸€ä¸ªä¸‰å…ƒç»„å˜›ï¼Ÿ
æ˜¯çš„ï¼Œå¤šå¥è¯å¯ä»¥åˆ†å®Œå¥æå–ã€‚

Nicholas-kaiï¼šbertæ¨¡å‹çš„å¤šå¤´æ˜¯ä¸€èµ·è®­ç»ƒè¿˜æ˜¯ä¸€ä¸ªä¸ªè®­ç»ƒï¼Ÿ
ä¸€èµ·è®­ç»ƒçš„ã€‚

å·¦ç‰è¾‰ï¼š pytorchåŠç²¾åº¦ä¸‹ æƒ³é‡å¤åå‘ä¼ æ’­ï¼Œæ€ä¹ˆè®¾ç½®retrainï¼Ÿä½¿ç”¨fp16äº† æƒ³åŠ å¯¹æŠ—è®­ç»ƒ ä½†æ˜¯éœ€è¦å¤šæ¬¡backwardï¼Œamp.scale_loss ä¹Ÿæ˜¯æœ‰ retain_graphçš„



Oliverï¼šè¿™ä¸€å¥ä¸ºå•¥å¤šä¸€ä¸ª.![image-20210730155827496](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730155827496.png)æ˜¯ç›¸å¯¹è·¯å¾„å¯¼å…¥çš„æ„æ€å—ï¼Ÿ
å¯¹çš„ï¼Œå½“å‰è·¯è·¯å¾„ä¸‹æœ‰ä¸ªmodule
æŠ¥é”™æ²¡æ‰¾åˆ°åŒ…ImportError: attempted relative import with no known parent packageï¼Œæˆ‘è¿™é‡Œæ˜¯æœ‰åŒ…çš„ã€‚![image-20210730155953280](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730155953280.png)
å—¯å—¯åº”è¯¥æ˜¯è·¯å¾„æœ‰é—®é¢˜äº†ï¼Œè¦ä¸ä½ æ”¹å†™æˆç»å¯¹è·¯å¾„ï¼Œæˆ–è€…æ·»åŠ åˆ°sys.path.append('xxx/model')ï¼Œfrom model.module import xxx
 No module named 'model'ï¼Œå¯ä»¥äº† 
å—¯å—¯ï¼Œæ‰§è¡Œå…¥å£æ–‡ä»¶ä¹Ÿä¼šå½±å“ã€‚
è¿™ä¸ªæ”¹æˆmodelçˆ¶çº§ç›®å½•åœ°å€å°±å¥½å•¦ã€‚
æ‰§è¡Œå…¥å£æ–‡ä»¶æ˜¯å•¥ï¼Ÿ
å°±æ˜¯ä½ ä½ è¿è¡Œçš„å“ªä¸ªæ–‡ä»¶ï¼Œæœ€å¥½importçš„æ—¶å€™æŠŠè·¯å¾„å†™å®Œæ•´ï¼Œæ¯”å¦‚é¦–å…ˆç¡®å®šå¥½é¡¹ç›®çš„ç›®å½•ï¼Œç„¶åimportçš„æ—¶å€™å¦‚æœæŠ¥é”™æ‰¾ä¸åˆ°çš„è¯ï¼Œå°±æŠŠæ·»åŠ sys.path.append('é¡¹ç›®ç›®å½•/å¯¼å…¥åŒ…çš„ä¸Šçº§ç›®å½•')
![image-20210730160218370](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730160218370.png)
https://blog.csdn.net/liudinglong1989/article/details/104468495

#### ç”¨argså‚æ•°æ€ä¹ˆdebugï¼Ÿ

argså‚æ•°è¦å‘½ä»¤è¡Œè¾“å…¥
https://blog.csdn.net/counte_rking/article/details/78837028
ï¼Œä½¿ç”¨Pycharmç»™Pythonç¨‹åºä¼ é€’å‚æ•°![image-20210730160334813](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730160334813.png)

ä¸ºä»€ä¹ˆæ¯ä¸€å±‚éƒ½è¦æ·»åŠ ä¸¤ä¸ªparameterï¼Ÿ
![image-20210730163118777](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730163118777.png)
weight_decayä¸º0.0çš„æ—¶å€™ ä¸¤ä¸ªparameteréƒ½æ˜¯ç›¸åŒçš„ï¼Ÿ
Michaelè€å¸ˆï¼šæ²¡æœ‰åŒºåˆ†çš„è¯ï¼Œå¯ä»¥åªåˆ†ä¸€ç»„
å¦‚æœè®¾ç½®äº†L2ï¼Œè¿˜éœ€è¦weight_decayä¸º0.0çš„parameterå—ï¼Ÿ
è¿™ä¸ªweght decayå°±æ˜¯L2ã€‚

æŸ³æ°ï¼šåœ¨main.pyé‡Œrunä¼šå‡ºç°OSError: Model name './bert_finetune_ner/resources/uncased_L-2_H-128_A-2' was not found in tokenizers model name list (bert-base-uncased, bert-large-uncased, bert-base-cased, bert-large-cased, bert-base-multilingual-uncased, bert-base-multilingual-cased, bert-base-chinese, bert-base-german-cased, bert-large-uncased-whole-word-masking, bert-large-cased-whole-word-masking, bert-large-uncased-whole-word-masking-finetuned-squad, bert-large-cased-whole-word-masking-finetuned-squad, bert-base-cased-finetuned-mrpc, bert-base-german-dbmdz-cased, bert-base-german-dbmdz-uncased, TurkuNLP/bert-base-finnish-cased-v1, TurkuNLP/bert-base-finnish-uncased-v1, wietsedv/bert-base-dutch-cased). We assumed './bert_finetune_ner/resources/uncased_L-2_H-128_A-2' was a path, a model identifier, or url to a directory containing vocabulary files named ['vocab.txt'] but couldn't find such vocabulary files at this path or url.
å¦‚æœç›´æ¥åœ¨å‘½ä»¤è¡Œå°±æ²¡é—®é¢˜ï¼Œæ˜¯æˆ‘ä¸ªä¾‹å—ï¼Ÿ
è¿™è·¯å¾„ä¸å­˜åœ¨å—ï¼Ÿä½ è¦ä¸å†™ç»å¯¹è·¯å¾„ã€‚
å­˜åœ¨ï¼Œå—¯å‘¢ã€‚

#### [-100]

Oliverï¼š![image-20210730163341239](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730163341239.png)
æˆ‘debugå‡ºç°è¿™ä¸ªé”™è¯¯ï¼Œæ­£å¸¸è¿è¡Œåˆ™ä¸å‡ºç°ï¼Œç½‘ä¸Šçš„æ–¹æ³•è¯•è¿‡ä¹Ÿä¸è¡Œï¼Œä¼šæ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿ

```python
 import os
os.environ['CUDA_LAUNCH_BLOCKING'] = "1"
```

ä½ åŠ ä¸Šè¿™ä¸¤å¥è¯ï¼Œçœ‹çœ‹å¯ä»¥è°ƒè¯•ä¸
è¯•è¿‡äº† ä¸è¡Œã€‚è€Œä¸”æ˜¯ç”¨äº†crfæ‰æœ‰é—®é¢˜ ä¸ç”¨debugæ²¡é—®é¢˜
![image-20210730163508487](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730163508487.png)
æˆ‘æŸ¥äº†ä¸‹åº”è¯¥æ˜¯æ ‡ç­¾è¶Šç•Œçš„é—®é¢˜ï¼Œä½ çœ‹çœ‹æ˜¯ä¸æ˜¯æ ‡ç­¾æœ‰è¶Šç•Œçš„ï¼Œ![image-20210730163531330](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730163531330.png)
ä½ å¯ä»¥ç”¨cpuè·‘ä¸€ä¸‹ï¼Œæˆ‘ä¹‹å‰ä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ªæ–¹å¼ï¼šcpuè¿è¡Œå¯ä»¥æç¤ºé‚£é‡Œç´¢å¼•è¶Šç•Œã€‚
æˆ‘åˆšåˆšæŸ¥è¿‡æ ‡ç­¾ æˆ‘å†è¯•è¯•ï¼æˆ‘è¿™ä¹Ÿæ²¡å¤šå‘€![image-20210730163557646](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730163557646.png)

æ ‡ç­¾æ•°ï¼Œè¦æŸ¥å“ªé‡Œçš„æ ‡ç­¾ï¼Ÿ
![image-20210730163647022](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730163647022.png)

ä½ è¿™ä¸ªæ–¹å¼å°è¯•äº†å—ï¼Ÿä½ æŠŠgpuç¦ç”¨äº†ï¼Œç„¶ådebugè¯•è¯•ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰æŠ¥å‡ºå…·ä½“çš„é”™è¯¯ã€‚
æ˜¯è¶Šç•Œäº†ï¼Œä½†æ˜¯æˆ‘æ‰¾ä¸åˆ°ï¼Œ![image-20210730163713845](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730163713845.png)
è¿™ä¸ª-100ï¼Œä½ æ£€æŸ¥ä¸‹æ˜¯å¦åœ¨è¾“å…¥çš„xé‡Œé¢æˆ–è€…yï¼Œåº”è¯¥æœ‰çš„
tokenizerå‡ºæ¥çš„xä¸yå—ï¼Ÿ
å¯¹çš„ã€‚ä½ ç°åœ¨ç›´æ¥ç”¨cpuè¿è¡Œå‘¢ï¼Œåˆ«debugï¼Œçœ‹çœ‹èƒ½å®šä½å‡ºé”™è¯¯ç ã€‚

```python
IndexError: index -100 is out of bounds for dimension 0 with size 39
```

æ²¡æœ‰å®šä½å‡ºã€‚
â€œ 0 with size 39â€è¿™ä¸ªåº”è¯¥æ˜¯40ä¸ªæ ‡ç­¾å§ï¼Ÿ
![image-20210730163844223](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730163844223.png)
æ‰€ä»¥é—®é¢˜å‡ºç°åœ¨äº†yé‡Œé¢
![image-20210730163904599](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730163904599.png)

å·²ç»ç»™å‡ºäº†ï¼Œä½ çœ‹çœ‹ä½ çš„yæ˜¯ä¸æ˜¯é‡Œé¢æœ‰-100è¿™ä¸ªç´¢å¼•ï¼Œä½ å¯ä»¥éå†ä¸‹æ•°æ®ï¼Œæ£€æŸ¥ä¸‹ã€‚
æœ‰ padè¿™äº›æ˜¯-100ã€‚
ä½ æ£€æŸ¥ä¸‹yé‡Œé¢æœ‰å—ï¼Ÿ
æœ‰-100ã€‚![image-20210730163940429](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730163940429.png)

æˆ‘æŸ¥è¿‡tokenizerè¾“å‡ºçš„input_idsä¸labelï¼Œç»´åº¦éƒ½æ˜¯(batch_size, max_len)
![image-20210730165427301](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730165427301.png)
logitsç»´åº¦æ˜¯[B, L, num_labels]ï¼Œè¿™æ ·æœ‰é—®é¢˜å—ï¼Ÿ
æ²¡æœ‰é—®é¢˜è¿™æ ·ï¼Œä½ æ˜¨å¤©ä¸æ˜¯è¯´ä½ çš„tagsé‡Œé¢æœ‰-100å—ï¼Ÿä½ çœ‹çœ‹æ˜¯ä¸æ˜¯ä½ æ•°æ®å¤„ç†çš„é—®é¢˜ï¼Œæ€ä¹ˆå¯èƒ½æœ‰-100è¿™ä¸ªæ•°å­—ã€‚
padã€clsè¿™äº›åº”è¯¥ç”¨ä»€ä¹ˆï¼Ÿlabel idï¼ŒMè€å¸ˆä¹‹å‰çš„ä»£ç å°±æ˜¯ç”¨-100çš„ æˆ‘è·‘é€šäº†æ²¡é—®é¢˜ã€‚
æ–‡æœ¬é‡Œé¢å‡ºç°æ˜¯å¯ä»¥çš„ï¼Œå°±æ˜¯labelä¸åº”è¯¥å‡ºç°å§ã€‚
æˆ‘è¯•è¯•æŠŠè¿™äº›æ”¹æˆ0ã€‚ã€‚ã€‚é¢ï¼ŒçœŸçš„æ˜¯ï¼ç°åœ¨è·‘é€šäº†ã€‚ä½†æ˜¯å¾ˆå¥‡æ€ª Mè€å¸ˆçš„åŸä»£ç -100å°±å¯ä»¥



æ°¸ä¸‰å°ºï¼šåŠ©æ•™ï¼Œæˆ‘ç”¨tokenizer.encode_plusï¼Œå‡å¦‚æˆ‘è¾“å…¥çš„å¥å­æ˜¯ä¸¤ä¸ªå¥å­t1ï¼Œt2æ‹¼æ¥ä¹‹åçš„ï¼Œé‚£æˆ‘çš„token_type_idsåº”è¯¥æ€ä¹ˆè®¾ç½®å•Šï¼Ÿæˆ‘åœ¨åšæ‹¼æ¥çš„æ—¶å€™ t1 + â€˜[SEP]â€™ + t2ã€‚å¦‚æœè®¾ç½®return_token_type_ids=True ï¼Œ å¦‚æœè®¾ç½®return_token_type_ids=True ï¼Œå¥½åƒä¼šæŠŠ t1 + â€˜[SEP]â€™ + t2 çœ‹æˆæ˜¯ä¸€ä¸ªå¥å­ï¼Ÿ
åˆ«è¾“å…¥ä¸¤ä¸ªæ‹¼æ¥çš„ï¼Œå¯ä»¥æ¥å—ä¸¤ä¸ªå‚æ•°ã€‚å¯ä»¥æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œå¦‚æœéå¾—æ‹¼æ¥è¾“å…¥çš„è¯ï¼Œä½ å¯ä»¥é‡æ–°å¯¹tokentypeidsèµ‹å€¼ï¼Œæ ¹æ®sepè¿™ä¸ªç¬¦å·ï¼Œå‰é¢çš„éƒ½æ˜¯0ï¼Œåé¢éƒ½æ˜¯1ã€‚
é‚£å¦‚æœæ˜¯ä¸‰ä¸ªå¥å­å‘¢ï¼Œä¸€ä¸ªcls ä¸¤ä¸ªsepï¼Œè¿™ç§åªèƒ½é‡æ–°èµ‹å€¼äº†å—ï¼Ÿ
å¯¹çš„ï¼Œä¸‰ä¸ªå¥å­ï¼Œä¹Ÿå¾—å¤„ç†æˆä¸¤ä¸ªå¥å­å§ï¼Œåªèƒ½æ¥å—ä¸¤ç§ç±»å‹çš„token typeï¼Œ0å’Œ1ã€‚
bertåªèƒ½æ¥å—ä¸¤ç§0å’Œ1ä¸¤ç§token_type_idå—ï¼Ÿ
ä½ è¯•ä¸‹ 0 1 2å¯ä»¥å—ï¼Ÿæˆ‘ä¹‹å‰æ²¡æœ‰å°è¯•è¿‡ï¼Œä½†æ˜¯æ„Ÿè§‰ä¼šè¶…å‡ºtoken typeçš„ç´¢å¼•ï¼Œä»–é¢„è®­ç»ƒçš„æ—¶å€™ç”¨çš„nspä»»åŠ¡ã€‚
æœ‰é“ç†å•Šï¼Œ![image-20210730164258340](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730164258340.png)

æˆ‘å¦‚æœæ‰‹åŠ¨è®¾ç½® è¿™é‡Œ add_special_token å’Œ return_token_type_idsï¼Œåº”è¯¥æ€ä¹ˆå¡«å‘¢ï¼Ÿ
![image-20210730164317675](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730164317675.png)

add_special_tokens æ˜¯boolç±»å‹çš„ã€‚
![image-20210730164330044](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730164330044.png)

return_token_type_ids è¿™ä¸ªä¹Ÿæ˜¯ï¼Œä¸èƒ½è®¾ç½®ç‰¹æ®Šçš„tokenã€‚

imoprtance*ï¼š![image-20210730164356683](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730164356683.png)

åŠ©æ•™å¤§å¤§ï¼Œè¿™ä¸ªé”™è¯¯æ˜¯ä»€ä¹ˆåŸå› ï¼ŸæŠŠfocal lossè®¾ç½®ä¸ºtrueï¼Œå°±æŠ¥äº†è¿™ä¸ªé”™è¯¯ã€‚
![image-20210730164729889](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730164729889.png)

focal lossæ²¡æœ‰è‡ªåŠ¨æ±‚å¯¼çš„ï¼Œfocal lossæ˜¯ä¸æ˜¯æ²¡æœ‰ç»§æ‰¿torch.nnï¼Œhttps://github.com/yatengLG/Focal-Loss-Pytorchï¼Œä½ çœ‹çœ‹è¿™ä¸ªä¾‹å­æ˜¯ä¸æ˜¯ç¼ºå°‘ä¸€äº›ä¸œè¥¿



å´æ–°åˆšï¼š![image-20210730164918977](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730164918977.png)ç¬¬ä¸€æ¬¡å¤ç°ï¼ŒæŠ¥è¿™ä¸ªé”™ï¼Œæ€ä¹ˆè§£å†³ï¼Ÿ
ä½ æ•°æ®æ˜¯ä¸æ˜¯æ„å»ºçš„æœ‰é—®é¢˜ï¼Ÿä½ æ£€æŸ¥ä¸‹ä½ çš„æ•°æ®![image-20210730164954287](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730164954287.png)

ä½ ä¸‹é¢çš„é”™è¯¯æ˜¯ä»€ä¹ˆï¼Ÿ
![image-20210730165011441](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730165011441.png)

![image-20210730165015946](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730165015946.png)

```python
OSError: Model name './bert_finetune_ner/resources/uncased_L-2_H-128_A-2' was not found in tokenizers model name list (bert-base-uncased, bert-large-uncased, bert-base-cased, bert-large-cased, bert-base-multilingual-uncased, bert-base-multilingual-cased, bert-base-chinese, bert-base-german-cased, bert-large-uncased-whole-word-masking, bert-large-cased-whole-word-masking, bert-large-uncased-whole-word-masking-finetuned-squad, bert-large-cased-whole-word-masking-finetuned-squad, bert-base-cased-finetuned-mrpc, bert-base-german-dbmdz-cased, bert-base-german-dbmdz-uncased, TurkuNLP/bert-base-finnish-cased-v1, TurkuNLP/bert-base-finnish-uncased-v1, wietsedv/bert-base-dutch-cased). We assumed './bert_finetune_ner/resources/uncased_L-2_H-128_A-2' was a path, a model identifier, or url to a directory containing vocabulary files named ['vocab.txt'] but couldn't find such vocabulary files at this path or url.
```

ä½ çœ‹ä¸‹è¿™è·¯å¾„æœ‰å—ï¼Œæ²¡æœ‰çš„è¯ï¼Œå†™ç»å¯¹è·¯å¾„ï¼ŒæŸ¥äº†ä¸€ä¸‹ï¼Œè¯´æ²¡æœ‰'vocab.txt'ï¼›ä½†æˆ‘ç¡®å®æ˜¯æœ‰æ­¤æ–‡ä»¶çš„ã€‚æ‰§è¡Œå‚æ•°ä¸­ï¼Œä¼¼ä¹åˆæ²¡çœ‹åˆ°å®šä¹‰'uncased_L-2_H-128_A-2'çš„åœ°æ–¹
å°±æ¯”å¦‚ä»–åœ¨ä½ è·¯å¾„ä¸‹çš„Dç›˜æŸä¸ªæ–‡ä»¶å¤¹ï¼Œæ¯”å¦‚Dï¼š/bert_finetune_ner/resources/
ç„¶åå‘¢ï¼Ÿå¦‚ä½•å®šä¹‰è¯¥æ–‡ä»¶å¤¹ï¼Ÿ
![image-20210730165205615](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730165205615.png)

ç±»ä¼¼è¿™æ ·ï¼Œä½ å†™å®Œæ•´å°±å¯ä»¥äº†ã€‚
![image-20210730165222766](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730165222766.png)
utils.pyæ–‡ä»¶çš„è¿™é‡Œ æ·»åŠ ç»å¯¹è·¯å¾„

æ°¸ä¸‰å°ºï¼š![image-20210730165845101](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730165845101.png)
â€…åŠ©æ•™ï¼Œæˆ‘æœ€è¿‘åœ¨åšå¤šè½®å¯¹è¯çš„ä»»åŠ¡ï¼Œæˆ‘ç°åœ¨æŠŠå‰ä¸‰å¥è¯åšäº†æ‹¼æ¥å’Œembeddingï¼Œä½†æ˜¯æˆ‘çš„labelåº”è¯¥æ€ä¹ˆå¤„ç†å•Šï¼Ÿä»»åŠ¡æ˜¯ç”Ÿæˆ query-02-rewriteï¼Œéš¾é“æˆ‘è¦ç”¨è§„åˆ™å»æ‰“æ ‡ï¼Ÿ
ä½ æƒ³è¦åšä»€ä¹ˆå¤„ç†ï¼Ÿç°åœ¨labelæœ‰äº†ï¼Œ
å°±æ˜¯ï¼Œæˆ‘ç°åœ¨query-02-rewriteè¿˜æ²¡æœ‰åšå¤„ç†ï¼Œæˆ‘æƒ³æ˜¯ä¸æ˜¯è¦æŠŠquery-02-rewriteåšåºåˆ—æ ‡æ³¨å‡ºå®ä½“ï¼Ÿ![image-20210730165930215](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730165930215.png)
<img src="%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730165942508.png" alt="image-20210730165942508" style="zoom:67%;" />

è¿™æ˜¯æˆ‘ç°åœ¨çš„inputé‡Œçš„ä¸œè¥¿ labelè¿™é‡Œæˆ‘ä¸å¤ªæ‡‚æ€å†™ã€‚
ä½ è·‘çš„æ¨¡å‹æ˜¯ç”Ÿæˆå¼æ¨¡å‹å§ï¼Œæ‰€ä»¥è¿™é‡Œä½ å†™æˆquery-02-rewriteï¼Œè¿™ä¸ªå°±å¯ä»¥
æˆ‘ç”¨çš„æœ€åŸºç¡€çš„bertï¼Œæˆ‘å†ç¢ç£¨ç¢ç£¨è¿™ä¸ªæµç¨‹ï¼Œæˆ‘è¿™ä¸ªå¥½åƒä¹Ÿä¸æ˜¯ç”Ÿæˆå¼ä»»åŠ¡ï¼Œå…¶å®æ˜¯æŒ‡ä»£æ¶ˆè§£

Trouble_Slayerï¼š![image-20210730170054732](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730170054732.png)

è¿™ä¸ªé—®é¢˜å•¥æƒ…å†µå•Šï¼Ÿ
![image-20210730170107732](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730170107732.png)

ä½ çœ‹ä¸‹æ˜¯ä¸æ˜¯å†…å­˜ä¸è¶³ï¼Œä½ é‡å¯ä¸‹notebookæˆ–è€…å‡å°batch sizeè¯•ä¸‹
ä½†æˆ‘è¿™ä¸ªæŠ¥é”™å’Œä½ å‘çš„é‚£ä¸ªä¸ä¸€æ ·å‘¢
![image-20210730170130506](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730170130506.png)

![image-20210730170136538](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730170136538.png)
https://blog.csdn.net/li_jiaoyang/article/details/116047462
ä½ çœ‹ä¸‹æ˜¯ä¸æ˜¯è¿™ä¸ªï¼Œå‡å°ä¸‹bsè¯•è¯•
![image-20210730170204244](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730170204244.png)
å¥½åƒå¤§å¤šæ˜¯cudaç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œä½ å¯ä»¥æ£€æŸ¥ä¸‹ä½ çš„torchå¯ä»¥ç”¨gpuå—?
å¯ä»¥ç”¨gpuã€‚
é‚£ä¼°è®¡æ˜¯å†…å­˜ä¸è¶³ã€‚
æˆ‘6gç”¨çš„roberta ä¼šä¸è¶³å—ï¼Ÿæˆ‘è®°å¾—ä»¥å‰æ˜¾å­˜ä¸è¶³æŠ¥çš„æ˜¯out of memçš„é”™å•Šï¼Œè·Ÿè¿™æ¬¡ä¸ä¸€æ ·ï¼Œæˆ‘ç”¨çš„ä¸­æ–‡roberta baseã€‚
ä½ å‡å°bsè¯•è¯•ï¼Œå…ˆé‡å¯notebookï¼Œç„¶åå‡å°bsã€‚
bså·²ç»æ˜¯2äº†ã€‚
è®¾ç½®æˆ1ï¼Œè¯•è¯•ã€‚
(æˆ‘ï¼šæ€»ä¹‹è¿™ä½åŒå­¦å¥½åƒè¿˜æ˜¯æ˜¾å¡é©±åŠ¨ï¼Œtorchï¼Œcudaç‰ˆæœ¬ä¸åŒ¹é…çš„é—®é¢˜ï¼Œå¥½æ‡’çš„æ•´ç†55.)
https://pytorch.org/get-started/previous-versions/
æ™¨æ›¦ï¼šèƒ½å®‰è£…ä»€ä¹ˆç‰ˆæœ¬çš„cudaï¼Œæ˜¯ç”±æ˜¾å¡é©±åŠ¨å†³å®šçš„
![image-20210730170637178](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730170637178.png)
æˆ‘çš„æ˜¾å¡é©±åŠ¨æ”¯æŒcuda 11.2,æˆ‘å®‰è£…çš„ä¹Ÿæ˜¯11.2ï¼Œä½†torch1.9+cuda111ï¼Œtorchvionå¥½åƒ11.3ï¼Œä½ éƒ½å¼„åˆ°ä½ çš„æ˜¾å¡æ”¯æŒçš„æœ€æ–°è¯•è¯•ã€‚æˆ‘çš„åŸºæœ¬æ˜¯æœ€æ–°æ²¡æœ‰é—®é¢˜ï¼Œtorchä¸Šå†™çš„åªæ”¯æŒåˆ°11.1ï¼Œä½†å®é™…ä¸Šè·‘11.2æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚
![image-20210730170718168](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730170718168.png)
åŠ©æ•™ï¼šå—¯å—¯æ˜¯çš„ï¼Œè¦çœ‹ä¸‹è¿™ä¸¤ä¸ªæ˜¯å¦å…¼å®¹

#### æ€ä¹ˆçœ‹æ˜¾å¡å’Œcudaç‰ˆæœ¬æ˜¯å¦å…¼å®¹

https://docs.nvidia.com/cuda/cuda-toolkit-release-notes/index.html
![image-20210730170806905](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730170806905.png)

åˆ°è¿™é‡Œè¿™ä½åŒå­¦å‘ç°äº†ä»–çš„æ˜¾å¡é©±åŠ¨æ‰445 å’Œ11.0ä¸å…¼å®¹ï¼Œå‡†å¤‡å‡çº§é©±åŠ¨è¯•è¯•

æ°¸ä¸‰å°ºï¼šåŠ©æ•™ï¼Œå¦‚æœæ˜¯nerä»»åŠ¡ï¼Œæˆ‘çš„bertè¾“å…¥æ˜¯æ–‡æœ¬å’Œæ ‡æ³¨å¥½çš„åºåˆ—ï¼Œé‚£æˆ‘è¾“å‡ºçš„ç»´åº¦åº”è¯¥è®¾ç½®æˆä»€ä¹ˆï¼Ÿ ğŸ¤”
@æ°¸æ²¢â€…è¾“å‡ºçš„ç»´åº¦æ˜¯ä½ åºåˆ—æ ‡ç­¾ç±»åˆ«çš„ä¸ªæ•°
é‚£å¦‚æœæˆ‘çš„æ ‡æ³¨åºåˆ—æ˜¯ 000100000200 ï¼Œ bertçš„è¾“å‡ºç»´åº¦åº”è¯¥æ˜¯3ï¼Ÿ
å¯¹çš„ 
[0ï¼Œ1ï¼Œ2ï¼½
0 1 2ï¼Œåªæœ‰è¿™ä¸‰ä¸ªæ ‡ç­¾å§
![image-20210730171027213](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730171027213.png)

è¿™æ˜¯æˆ‘æƒ³å®ç°çš„è¿‡ç¨‹ å¦‚æœåªæœ‰ä¸€ä¸ªå®ä½“åºåˆ—é‡Œå°±æ˜¯1 ä¸¤ä¸ªå®ä½“å°±æ˜¯1 2
å…¶ä»–æ ·æœ¬ä¹Ÿæœ‰0å§ï¼Œå¾—è®¾ç½®å…¨å±€çš„labelæ€»æ•°ï¼Œè¿˜æ˜¯3ï¼Œå¦åˆ™é‡åˆ°labelç­‰äº0çš„æ—¶å€™labelä¸ªæ•°å¯¹ä¸ä¸Šã€‚
é‚£æˆ‘è¿™æ ·è®¾ç½®ä¹‹å outputçš„ç»´åº¦åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ
æ¯”å¦‚ä¸€æ¡æ ·æœ¬çš„è¯ï¼Œæ ·æœ¬é•¿åº¦ä¸º10ï¼Œ3ä¸ªtagç§ç±»ï¼Œï¼ˆ1ï¼Œ10ï¼Œ3)
batch_size ï¼Œ max_lenï¼Œlabel_sizeä¹ˆï¼Ÿæ˜¯ä¸æ˜¯è¿™ä¸ªæ ·å­ï¼Ÿ
<img src="%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730171117684.png" alt="image-20210730171117684" style="zoom:67%;" />

å¯¹çš„ï¼Œæ¯ä¸ªtokenå¯¹åº”ä¸åŒtagçš„æ¦‚ç‡ã€‚
![image-20210730171143184](%E7%BE%A4%E8%81%8A%E8%AE%B0%E5%BD%95.assets/image-20210730171143184.png)
ä½†æˆ‘æ¨¡å‹å¦‚æœè¿™æ ·å†™çš„è¯ï¼Œå®ƒçš„è¾“å‡ºå¤§å°ä¸è¿˜æ˜¯label_sizeå—ï¼Ÿæ€ä¹ˆå˜æˆæˆ‘æƒ³è¦çš„é‚£ä¸ª[batch_size ï¼Œ max_lenï¼Œlabel_size]
ä½ è¿™æ ·æ˜¯å¯¹æ•´ä¸ªå¥å­åšåˆ†ç±»ï¼Œä½ ç›´æ¥ç”¨BertForTokenClassificationæ•´ä¸ªï¼Œå¯¹æ¯ä¸ªtoeknè¿›è¡Œåˆ†ç±»ã€‚
https://huggingface.co/transformers/model_doc/bert.html#bertfortokenclassification
è¿˜æœ‰è¿™ä¸ªï¼Œæˆ‘å»çœ‹çœ‹ï¼

